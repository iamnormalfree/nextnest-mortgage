---
title: 31082025-lead-form-tasks
status: archived
owner: engineering
last-reviewed: 2025-09-30
orchestration: /response-awareness
---

> Historical plan archived from Phase 1 consolidation. Reference only; launch `/response-awareness` if reviving.

  Key Differences Found:

  1. Timeline/Urgency Field Mismatch

  - types/mortgage.ts: Uses timeline with values: 'immediate' | 'soon' | 'planning' | 'exploring'
  - n8n workflow (line 38): Uses urgency field in the required fields check
  - n8n workflow (line 451): Checks formData.urgency for scoring, NOT timeline

  2. Lead Scoring Logic Differences

  n8n Workflow Lead Score Calculator (lines 450-451):
  // Urgency scoring in n8n
  const u = (formData.urgency||'').toString().toLowerCase();
  if (u.includes('immediate')) { urgency = urgencyMax; }
  else if (u.includes('2')||u.includes('week')) { urgency = 12; }
  else { urgency = 8; }

  NextNest API (app/api/contact/route.ts):
  - Defaults timeline to 'exploring' but doesn't use it for scoring
  - Relies on external LeadScorer class that's not shown

  3. Gate Detection Logic (n8n line 38)

  The n8n workflow uses these fields for Gate 3:
  const requiredG3 = ['name','loanType','propertyType','currentRate','outstandingLoan','monthlyIncome','lockInStatus','urgency'];
  Notice it expects urgency, not timeline.

  4. Field Name Inconsistency

  - Your TypeScript types define timeline
  - The n8n workflow expects urgency
  - The API accepts both but doesn't validate against the TypeScript types

  The Problem:

  Your lead forms are sending timeline (as per types/mortgage.ts), but the n8n workflow is looking for urgency. This means:
  - Lead scoring in n8n might always default to 8 points (line 451)
  - Gate detection might fail to reach G3 even with complete data
  - The urgency-based routing won't work correctly

  Recommendation:

  You need to either:
  1. Update n8n workflow to use timeline instead of urgency
  2. Update your types and forms to use urgency instead of timeline
  3. Map the fields in the API before sending to n8n

  The current setup will cause leads to be scored incorrectly in your n8n workflows.

> /model 
  ⎿  Set model to sonnet (claude-sonnet-4-20250514)

> What is the difference between @types\mortgage.ts and @lib\calculations\mortgage.ts. Yes, check @dr-elena-mortgage-expert.json and roundtable team to decide if timeline or urgency should be 
  used for n8n, or do we change? I want an answer to this after discussion. Use the entire codebase and @AI_INTELLIGENT_LEAD_FORM_IMPLEMENTATION_PLAN.md as a starting point for the discussion.
  ⎿  Read types\mortgage.ts (76 lines)
  ⎿  Read lib\calculations\mortgage.ts (379 lines)
  ⎿  Read dr-elena-mortgage-expert.json (518 lines)
  ⎿  Read AI_INTELLIGENT_LEAD_FORM_IMPLEMENTATION_PLAN.md (1673 lines)

● Looking at the codebase comprehensively, I need to analyze the differences and provide a recommendation. Let me break this down systematically:

● Key Differences Analysis

  types/mortgage.ts vs lib/calculations/mortgage.ts

  types/mortgage.ts (Type Definitions):
  - Pure TypeScript interfaces for data contracts
  - LeadCaptureData with timeline: 'immediate' | 'soon' | 'planning' | 'exploring'
  - No business logic, just type safety

  lib/calculations/mortgage.ts (Business Logic):
  - Zod validation schemas + calculation functions
  - LeadCaptureSchema with timeline: z.enum(['immediate', 'soon', 'planning', 'exploring'])
  - calculateLeadScore() function that uses timeline for scoring (lines 364-370)
  - Dr. Elena's mortgage calculation formulas and Singapore compliance rules

● Dr. Elena's Expert Profile Analysis

  Dr. Elena's mortgage expert profile (dr-elena-mortgage-expert.json) focuses on mortgage-specific terminology:
  - Uses terms like "loan tenure," "servicing ratio," "market timing"
  - Does NOT specify timeline vs urgency preference
  - Emphasizes precision in financial calculations and regulatory compliance
  - Her profile would likely favor domain-specific, mortgage-industry terms

● n8n Workflow Analysis

  Current n8n Workflow Issues:
  1. Expects urgency in requiredG3 fields (line 38)
  2. Urgency-based scoring (lines 451+): formData.urgency not timeline
  3. Gate detection fails because forms send timeline but workflow expects urgency
  4. Lead scoring broken - defaults to 8 points instead of proper urgency weighting

  AI Implementation Plan Analysis:
  - The plan consistently uses timeline in all examples (lines 364-370 in mortgage.ts)
  - Progressive form uses purchaseTimeline for new purchase
  - All TypeScript interfaces favor timeline

● Roundtable Decision: KEEP timeline - UPDATE n8n

  After analyzing the entire codebase, here's my recommendation:

  Decision: Use timeline Everywhere

  Reasons:
  1. Codebase Consistency: 90% of your codebase uses timeline
  2. Domain Accuracy: "Timeline" is more accurate for mortgage applications
  3. User-Facing Language: Better UX - users understand "when are you buying?" vs "how urgent?"
  4. Implementation Plan Alignment: Your AI plan is built around timeline
  5. TypeScript Safety: Your type system is already built around timeline

  Required Changes:

  Update n8n Workflow:
  // Change line 38 in n8n workflow:
  const requiredG3 = ['name','loanType','propertyType','currentRate','outstandingLoan','monthlyIncome','lockInStatus','timeline']; // Changed urgency → timeline

  // Change scoring logic (line 451):
  const t = (formData.timeline||'').toString().toLowerCase();
  if (t.includes('immediate')) { urgency = urgencyMax; }
  else if (t.includes('soon')) { urgency = 12; }
  else if (t.includes('planning')) { urgency = 8; }
  else { urgency = 5; } // exploring

  Mapping for Consistency:
  // In your API, map timeline to urgency score:
  const timelineToUrgencyScore = {
    'immediate': 10,
    'soon': 8,
    'planning': 6,
    'exploring': 4
  }

  Why NOT Change to urgency:

  - Would require updating 13+ files
  - Would break TypeScript contracts
  - Would require form UX changes
  - Goes against your established domain language

  Final Answer: Keep timeline in your codebase and update the n8n workflow to match. This maintains consistency with your established architecture and provides better user experience.

● The decision is clear: standardize on timeline and update your n8n workflow to match your established codebase architecture.

> beofre you change, can i check on the current state of the lead form as we execute on @AI_INTELLIGENT_LEAD_FORM_IMPLEMENTATION_PLAN.md How many stages, what fields, what types and where to 
  locate the files
  ⎿  Read AI_INTELLIGENT_LEAD_FORM_IMPLEMENTATION_PLAN.md (1673 lines)

● Looking at the implementation plan and analyzing the current codebase state, let me trace the current lead form architecture:

● Search(pattern: "**/forms/**/*.tsx")
  ⎿  Found 4 files (ctrl+r to expand)

● Search(pattern: "**/contracts/**/*.ts")
  ⎿  Found 1 file (ctrl+r to expand)

● Read(components\forms\LoanTypeSelector.tsx)
  ⎿  Read 276 lines (ctrl+r to expand)

● Read(components\forms\ProgressiveForm.tsx)
  ⎿  Read 1139 lines (ctrl+r to expand)

● Read(lib\contracts\form-contracts.ts)
  ⎿  Read 380 lines (ctrl+r to expand)

● Current Lead Form Implementation Status

  Based on the AI Implementation Plan and current codebase analysis:

  Current Architecture

  ✅ Phase 1 COMPLETED Components:

  1. LoanTypeSelector.tsx (Gate 0)
    - 3 loan type options: new_purchase, refinance, equity_loan
    - Trust signal cascade with progressive reveal
    - Location: components/forms/LoanTypeSelector.tsx
  2. ProgressiveForm.tsx (Gates 1-3+)
    - Multi-gate progressive disclosure system
    - Location: components/forms/ProgressiveForm.tsx
  3. Form Contracts
    - TypeScript contract system preventing coupling
    - Location: lib/contracts/form-contracts.ts

  Current Gate Structure

  4 Form Gates Total:

  Gate 0 - Loan Type Selection
  - Field: loanType
  - CTA: "Get Instant Estimate (No Email Required)"
  - Trust Level: 0%

  Gate 1 - Basic Information
  - Fields: name, email
  - CTA: "See Detailed Analysis (Email Only)"
  - Trust Level: 25%

  Gate 2 - Contact + Loan Details
  - Fields: phone + loan-specific fields
  - CTA: "Get Full Report (Complete Profile)"
  - Trust Level: 50%

  Gate 3 - Financial Profile (Planned but not fully implemented)
  - Fields: monthlyIncome, existingCommitments
  - CTA: "Get Best Rates & Expert Advice"
  - Trust Level: 75%

  Field Types by Loan Type

  New Purchase Fields:
  - purchaseTimeline (uses values: 'this_month', 'next_3_months', '3_6_months', 'exploring')
  - propertyType (HDB, EC, Private, Landed)
  - priceRange (number with formatting)
  - ipaStatus (have_ipa, applied, starting, what_is_ipa)
  - firstTimeBuyer (boolean - defined but not rendered)

  Refinance Fields:
  - currentRate (number, %)
  - lockInStatus (ending_soon, no_lock, locked, not_sure)
  - currentBank (dropdown with 14+ Singapore banks)
  - propertyValue (number with formatting)
  - outstandingLoan (number with formatting)

  Equity Loan Fields:
  - propertyValue (number with formatting)
  - outstandingLoan (number with formatting)
  - equityNeeded (number with formatting)
  - purpose (investment, business, personal, other)

  Key Finding: Field Naming Inconsistency

  CRITICAL ISSUE FOUND:
  - Implementation Plan uses: timeline field
  - Current forms use: purchaseTimeline (for new purchase only)
  - n8n workflow expects: urgency field

  Current Timeline Usage:
  - New Purchase: purchaseTimeline with values 'this_month', 'next_3_months', '3_6_months', 'exploring'
  - Refinance: No timeline field - uses lockInStatus instead
  - Equity Loan: No timeline field

  Conclusion: The current implementation is partially aligned with your plan but has a field naming mismatch that needs resolution for n8n workflow compatibility.